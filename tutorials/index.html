
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="..">
      
      
        <link rel="next" href="../api_references/MamsiPls/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.11">
    
    
      
        <title>Tutorials - MAMSI v1.0.5</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.4af4bdda.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../stylesheets/extra.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="mamsi" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#tutorials-and-training-materials" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="MAMSI v1.0.5" class="md-header__button md-logo" aria-label="MAMSI v1.0.5" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            MAMSI v1.0.5
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Tutorials
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="MAMSI v1.0.5" class="md-nav__button md-logo" aria-label="MAMSI v1.0.5" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    MAMSI v1.0.5
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    MAMSI
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Tutorials
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Tutorials
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#training-materials" class="md-nav__link">
    <span class="md-ellipsis">
      Training Materials
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tutorial-example-classification" class="md-nav__link">
    <span class="md-ellipsis">
      Tutorial Example - Classification
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Tutorial Example - Classification">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#load-packages" class="md-nav__link">
    <span class="md-ellipsis">
      Load Packages
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#load-sample-data" class="md-nav__link">
    <span class="md-ellipsis">
      Load Sample Data
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#split-data" class="md-nav__link">
    <span class="md-ellipsis">
      Split data
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fit-model" class="md-nav__link">
    <span class="md-ellipsis">
      Fit Model
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Fit Model">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fit-mb-pls-model-and-estimate-lvs" class="md-nav__link">
    <span class="md-ellipsis">
      Fit MB-PLS Model and Estimate LVs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#evaluate-final-model" class="md-nav__link">
    <span class="md-ellipsis">
      Evaluate Final Model
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#estimate-feature-importance" class="md-nav__link">
    <span class="md-ellipsis">
      Estimate Feature Importance
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Estimate Feature Importance">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#multiblock-variable-importance-in-projection" class="md-nav__link">
    <span class="md-ellipsis">
      Multiblock Variable Importance in Projection
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#permutation-testing" class="md-nav__link">
    <span class="md-ellipsis">
      Permutation Testing
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#interpret-statistically-significant-features" class="md-nav__link">
    <span class="md-ellipsis">
      Interpret Statistically Significant Features
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Interpret Statistically Significant Features">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mamsi-structural-search-tool" class="md-nav__link">
    <span class="md-ellipsis">
      MAMSI Structural Search Tool
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    API References
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            API References
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../api_references/MamsiPls/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    MamsiPls
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../api_references/MamsiStructSearch/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    MamsiStructSearch
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#training-materials" class="md-nav__link">
    <span class="md-ellipsis">
      Training Materials
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tutorial-example-classification" class="md-nav__link">
    <span class="md-ellipsis">
      Tutorial Example - Classification
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Tutorial Example - Classification">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#load-packages" class="md-nav__link">
    <span class="md-ellipsis">
      Load Packages
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#load-sample-data" class="md-nav__link">
    <span class="md-ellipsis">
      Load Sample Data
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#split-data" class="md-nav__link">
    <span class="md-ellipsis">
      Split data
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fit-model" class="md-nav__link">
    <span class="md-ellipsis">
      Fit Model
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Fit Model">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fit-mb-pls-model-and-estimate-lvs" class="md-nav__link">
    <span class="md-ellipsis">
      Fit MB-PLS Model and Estimate LVs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#evaluate-final-model" class="md-nav__link">
    <span class="md-ellipsis">
      Evaluate Final Model
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#estimate-feature-importance" class="md-nav__link">
    <span class="md-ellipsis">
      Estimate Feature Importance
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Estimate Feature Importance">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#multiblock-variable-importance-in-projection" class="md-nav__link">
    <span class="md-ellipsis">
      Multiblock Variable Importance in Projection
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#permutation-testing" class="md-nav__link">
    <span class="md-ellipsis">
      Permutation Testing
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#interpret-statistically-significant-features" class="md-nav__link">
    <span class="md-ellipsis">
      Interpret Statistically Significant Features
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Interpret Statistically Significant Features">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mamsi-structural-search-tool" class="md-nav__link">
    <span class="md-ellipsis">
      MAMSI Structural Search Tool
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="tutorials-and-training-materials">Tutorials and Training Materials</h1>
<p><a href="https://github.com/kopeckylukas/py-mamsi/blob/main/LICENCE"><img alt="License" src="https://img.shields.io/badge/License-BSD_3--Clause-blue.svg" /></a>
<a href="https://kopeckylukas.github.io/py-mamsi/"><img alt="pages-build-deployment" src="https://github.com/kopeckylukas/py-mamsi/actions/workflows/pages/pages-build-deployment/badge.svg" /></a>
<a href="https://pypi.org/project/mamsi/"><img alt="PyPI version" src="https://img.shields.io/pypi/v/mamsi.svg" /></a>
<a href="https://zenodo.org/doi/10.5281/zenodo.13619607"><img alt="DOI" src="https://zenodo.org/badge/823594568.svg" /></a></p>
<h2 id="training-materials">Training Materials</h2>
<p>You can find all MAMSI training materials by visiting our <a href="https://github.com/kopeckylukas/py-mamsi-tutorials">MAMSI Tutorials</a> repository. </p>
<p>The <code>MamsiPls</code> class inherits from the <code>mbpls</code> package [<a href="../#references">1</a>]. For more information on MB-PLS, please visit <a href="https://mbpls.readthedocs.io/en/latest/index.html">mbpls Documentation</a>.</p>
<h2 id="tutorial-example-classification">Tutorial Example - Classification</h2>
<p>The Multi-Assay Mass Spectrometry Integration (<a href="https://github.com/kopeckylukas/py-mamsi">MAMSI</a>) workflow allows for integrative analysis of multiple metabolomics LC-MS assays data. The MAMSI workflow utilises a multi-block partial-least squares (MB-PLS) discriminant analysis algorithm, which allows for the integration of multiple assays and the subsequent identification of the most significant predictors (features). The identification of statistically significant predictors is done using a multi-block version of the variable importance in projection (MB-VIP) procedure coupled with permutation testing. This enables us to obtain empirical p-values for each feature across all assays.
MAMSI also offers an easy interpretation of significant features. This is done by grouping of the significant features based on their structural properties (mass-to-charge ratio and retention time) and compared to their correlations. This can be visualised by a network plot.</p>
<p>This notebook showcases the use of the MAMSI workflow for the prediction (classification) of the biological sex of patients within the AddNeuroMed cohort [<a href="../#references">3</a>] - dataset of Alzheimer's disease patients. For this task, we will use 3 metabolomics blood serum assays. The assays were processed by the <a href="https://phenomecentre.org">National Phenome Centre</a> following the NPC protocol [<a href="../#references">6</a>]. Subsequently, data were pre-processed using XCMS [<a href="../#references">7</a>] and nPYc toolbox [<a href="../#references">8</a>].</p>
<p>Assays Overview </p>
<table>
<thead>
<tr>
<th>Assay</th>
<th>Number of features</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>HPOS</td>
<td>681</td>
<td>Hydrophilic interaction liquid chromatography (<strong>HILIC</strong>) positive ionisation</td>
</tr>
<tr>
<td>LPOS</td>
<td>4,886</td>
<td>Lipidomic reversed  phase chromatography positive ionisation</td>
</tr>
<tr>
<td>LNEG</td>
<td>2,091</td>
<td>Lipidomic reversed phase chromatography negative ionisation</td>
</tr>
</tbody>
</table>
<p>Outcome variable: Biological Sex</p>
<table>
<thead>
<tr>
<th>Class</th>
<th>Number of samples</th>
</tr>
</thead>
<tbody>
<tr>
<td>Male</td>
<td>283</td>
</tr>
<tr>
<td>Female</td>
<td>294</td>
</tr>
</tbody>
</table>
<h3 id="load-packages">Load Packages</h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mamsi.mamsi_pls</span><span class="w"> </span><span class="kn">import</span> <span class="n">MamsiPls</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mamsi.mamsi_struct_search</span><span class="w"> </span><span class="kn">import</span> <span class="n">MamsiStructSearch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
</code></pre></div>
<h3 id="load-sample-data">Load Sample Data</h3>
<p><br> Data used within this quickstart guide originate from the the AddNeuroMed [<a href="../#references">1</a>] cohort - dataset of Alzheimer's disease patients. 
You can download the sample data from this <a href="https://github.com/kopeckylukas/py-mamsi-tutorials/tree/main/sample_data">link</a>.</p>
<div class="highlight"><pre><span></span><code><span class="n">metadata</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../sample_data/alz_metadata.csv&#39;</span><span class="p">)</span>
<span class="c1"># The PLS algorithm requires the response variable to be numeric. </span>
<span class="c1"># We will encode the outcome &quot;Gender&quot; (Biological Sex) as 1 for female and 0 for male subjects. </span>
<span class="n">y</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;Gender&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s1">&#39;Female&#39;</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>

<span class="c1"># Import LC-MS data</span>
<span class="c1"># Add prefix to the columns names. This will be crucial for interpreting the results later on.</span>
<span class="n">hpos</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;./sample_data/alz_hpos.csv&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">add_prefix</span><span class="p">(</span><span class="s1">&#39;HPOS_&#39;</span><span class="p">)</span>
<span class="n">lpos</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;./sample_data/alz_lpos.csv&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">add_prefix</span><span class="p">(</span><span class="s1">&#39;LPOS_&#39;</span><span class="p">)</span>
<span class="n">lneg</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;./sample_data/alz_lneg.csv&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">add_prefix</span><span class="p">(</span><span class="s1">&#39;LNEG_&#39;</span><span class="p">)</span>
</code></pre></div>
<h3 id="split-data">Split data</h3>
<p>Split the dataset into training and testing subsets. The training subset will be used to fit the model, for cross-validation and for estimation of the number of latent variables. Then, the testing subset will be used as an independent dataset to assess the performance of the model. This will ensure that the model is not over-fitted to the data and that it can predict the outcome of the samples. </p>
<div class="highlight"><pre><span></span><code><span class="c1"># Split data in the ratio 90:10 for training and testing respectively.</span>
<span class="n">hpos_train</span><span class="p">,</span> <span class="n">hpos_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">hpos</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

<span class="c1"># Split the other two blocks based on the indices of the hpos block.</span>
<span class="n">lpos_train</span> <span class="o">=</span> <span class="n">lpos</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">hpos_train</span><span class="o">.</span><span class="n">index</span><span class="p">,:]</span>
<span class="n">lneg_train</span> <span class="o">=</span> <span class="n">lneg</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">hpos_train</span><span class="o">.</span><span class="n">index</span><span class="p">,:]</span>

<span class="n">lpos_test</span> <span class="o">=</span> <span class="n">lpos</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">hpos_test</span><span class="o">.</span><span class="n">index</span><span class="p">,:]</span>
<span class="n">lneg_test</span> <span class="o">=</span> <span class="n">lneg</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">hpos_test</span><span class="o">.</span><span class="n">index</span><span class="p">,:]</span>
</code></pre></div>
<h3 id="fit-model">Fit Model</h3>
<h4 id="fit-mb-pls-model-and-estimate-lvs">Fit MB-PLS Model and Estimate LVs</h4>
<p>As an example, we will start by fitting a MB-PLS model (from the MamsiPls class) with 1 component/latent variable (LV) and using the standard scaler. As a result, we will obtain super scores, block loadings and scores and block importances. Note that MamsiPls inherits its behaviour from the <a href="https://pypi.org/project/mbpls/">mbpls</a> [<a href="../#references">1</a>] model which, by default, uses the <em>NIPALS</em> algorithm. To see all possible configurations for the <strong>MamsiPls</strong> and <strong>mbpls</strong> models, see the <a href="https://mbpls.readthedocs.io/en/latest/">mbpls documentation</a>.</p>
<p>We can then estimate the number of latent variables in the model. The MamsiPls class provides method <code>MamsiPls.estimate_lv()</code> to estimate number of LVs in the model using k-fold cross-validation (CV). The k-fold CV is repeated k-times corresponding to number of LVs in the most complex model. The lowest possible number of LVs where the model stabilised (model performance did not rise by adding more LVs) was selected as the final model.</p>
<p>For the classification task, you can choose from <code>'auc', 'precision', 'recall', 'f1', 'accuracy'</code> metrics to perform the LV estimation on the mean value of validation CV splits.
<div class="highlight"><pre><span></span><code><span class="n">mamsipls</span> <span class="o">=</span> <span class="n">MamsiPls</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">mamsipls</span><span class="o">.</span><span class="n">fit</span><span class="p">([</span><span class="n">hpos_train</span><span class="p">,</span> <span class="n">lpos_train</span><span class="p">,</span> <span class="n">lneg_train</span><span class="p">],</span> <span class="n">y_train</span><span class="p">)</span>

<span class="c1"># Estimate the number of latent variables in you model</span>
<span class="n">mamsipls</span><span class="o">.</span><span class="n">estimate_lv</span><span class="p">([</span><span class="n">hpos_train</span><span class="p">,</span> <span class="n">lpos_train</span><span class="p">,</span> <span class="n">lneg_train</span><span class="p">],</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;auc&#39;</span><span class="p">)</span>
</code></pre></div>
<img alt="LV estimation result" src="../images/lv_estimation.png" />
<br>The LV estimation result shows that the model has 6 latent variables/components. Adding more LVs to the model could lead to overfitting. </p>
<h4 id="evaluate-final-model">Evaluate Final Model</h4>
<p>We can evaluate the performance of the model by predicting the outcome on an independent (testing) dataset that has not been used for model training. For this, we will use the 'testing' subset that we obtained during the train-test-split. </p>
<p>We can get the performance scores by calling the <code>mamsipls.evaluate_class_model()</code> method.</p>
<p><div class="highlight"><pre><span></span><code><span class="n">predicted</span> <span class="o">=</span> <span class="n">mamsipls</span><span class="o">.</span><span class="n">evaluate_class_model</span><span class="p">([</span><span class="n">hpos_test</span><span class="p">,</span> <span class="n">lpos_test</span><span class="p">,</span> <span class="n">lneg_test</span><span class="p">],</span> <span class="n">y_test</span><span class="o">.</span><span class="n">array</span><span class="p">)</span>
</code></pre></div>
<img alt="Confusion Matrix" src="../images/confusion_matrix.png" /></p>
<table>
<thead>
<tr>
<th>Metric</th>
<th>Score</th>
</tr>
</thead>
<tbody>
<tr>
<td>Accuracy</td>
<td>0.966</td>
</tr>
<tr>
<td>Recall</td>
<td>1.0</td>
</tr>
<tr>
<td>Specificity</td>
<td>0.943</td>
</tr>
<tr>
<td>F<sub>1</sub> Score</td>
<td>0.971</td>
</tr>
<tr>
<td>AUC</td>
<td>0.933</td>
</tr>
</tbody>
</table>
<p>The scores and confusion matrix above indicate that the model performance has improved. If we are happy with such model, we can start with model interpretation. </p>
<h3 id="estimate-feature-importance">Estimate Feature Importance</h3>
<p>We can start with reviewing the Multi-Block Variable Importance in Projection (MB-VIP) scores [<a href="../#references">2</a>].
The MB-VIP metric is the sum (weighted by the amount of variance of Y explained by each respective component) of the squared weight values. It provides a summary of the importance of a variable accounting for all weight vectors. VIPs are bounded between 0 (no effect) and infinity. Because it is calculated from the weights <em>w</em>, for PLS models with a single component, these are directly proportional to <em>w<sup>2</sup></em>. The VIP metric has the disadvantage of pooling together <em>w</em> vectors from components which contribute a very small magnitude to the model's <em>R<sup>2</sup>Y</em>.</p>
<h4 id="multiblock-variable-importance-in-projection">Multiblock Variable Importance in Projection</h4>
<p><div class="highlight"><pre><span></span><code><span class="n">mb_vip</span> <span class="o">=</span> <span class="n">mamsipls</span><span class="o">.</span><span class="n">mb_vip</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>
<img alt="Multiblock VIP" src="../images/mb-vip.png" /></p>
<p>Unfortunately, the assessment of variable importance in MB-PLS multivariate models is not straightforward, given the choice of parameters and their different interpretations, especially in models with more than 1 LV. To obtain a ranking of variables from the data matrix X associated with Y, we recommend using permutation testing coupled with the MB-VIP metric to estimate the empirical p-values for each variable.</p>
<h4 id="permutation-testing">Permutation Testing</h4>
<p>You can perform permutation testing using the <code>MamsiPls.mb_vip_permtest()</code> method. We recommend to perform at least 10,000 permutations, but ideally &gt;100,000 for a good p-value estimate. You can find pre-calculated p-values at <a href="https://github.com/kopeckylukas/py-mamsi-tutorials/tree/main/sample_data">link</a>.</p>
<p>We can review the empirical null distribution of the MB-VIP scores of a statistically non-significant feature (1) and compare it to a statically significant feature (5769).</p>
<p>In both cases, the dashed line indicates the MB-VIP score for each feature of the observed (non-permuted) model. </p>
<p>The empirical p-values for the <em>i</em> <sup>th</sup> feature are calculated by dividing the number of MB-VIP scores of the <em>null (permuted)</em> models for the <em>i</em> <sup>th</sup> feature <strong>higher</strong> than the <em>observed</em> MB-VIP score for <em>i</em> <sup>th</sup> feature, by the total number of permutations.</p>
<p><div class="highlight"><pre><span></span><code><span class="n">p_vals</span><span class="p">,</span> <span class="n">null_vip</span> <span class="o">=</span> <span class="n">mamsipls</span><span class="o">.</span><span class="n">mb_vip_permtest</span><span class="p">([</span><span class="n">hpos</span><span class="p">,</span> <span class="n">lpos</span><span class="p">,</span> <span class="n">lneg</span><span class="p">],</span> <span class="n">y</span><span class="p">,</span> <span class="n">n_permutations</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">return_scores</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>
<img alt="Null Models Distribution" src="../images/null_models_distribution.png" /></p>
<p><em>Note that the pre-calculated <code>null_vip</code> file contains MB-VIP scores for first 400 null models (permutations) only so the p-value displayed on the plot below does not correspond with the plot itself.</em></p>
<h3 id="interpret-statistically-significant-features">Interpret Statistically Significant Features</h3>
<p><div class="highlight"><pre><span></span><code><span class="c1"># merge the LC-MS data into a single data frame</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">hpos</span><span class="p">,</span> <span class="n">lpos</span><span class="p">,</span> <span class="n">lneg</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Select features with p-value &lt; 0.01.</span>
<span class="c1"># You can also apply multiple testing correction methods to adjust the p-value threshold.</span>
<span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">p_vals</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">)</span>
<span class="n">selected</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">mask</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</code></pre></div>
You can use MAMSI Structural Search tool (<code>MamsiStructSearch()</code>) to help you understand the nature of statistically significant features. </p>
<p>Firstly, all features are split into retention time (<em>RT</em>) windows of 5 seconds intervals, then each RT window is searched for isotopologue signatures by searching mass differences of 1.00335 <em>Da</em> between mass-to-charge ratios (<em>m/z</em>) of the features; if two or more features resemble a mass isotopologue signature then they are grouped together. This is followed by a search for common adduct signatures. This is achieved by calculating hypothetical neutral masses based on common adducts in electrospray ionisation. If hypothetical neutral masses match for two or more features within a pre-defined tolerance (15 <em>ppm</em>) then these features are grouped together. Overlapping adduct clusters and isotopologue clusters are then merged to form structural clusters. Further, we search cross-assay clusters using [M+H]<sup>+</sup>/[M-H]<sup>-</sup> as link references. Additionally, our structural search tool, that utilises region of interest <a href="https://github.com/phenomecentre/npc-open-lcms">(ROI) files</a> from peakPantheR [<a href="../#references">4</a>], allows for automated annotation of  some features based on the <em>RT</em> for a given chromatography and <em>m/z</em>.</p>
<h4 id="mamsi-structural-search-tool">MAMSI Structural Search Tool</h4>
<p><div class="highlight"><pre><span></span><code><span class="c1"># First, we need to define the MamsiStructSearch object </span>
<span class="c1"># and choose the tolerances for the retention time and m/z matching.</span>
<span class="n">struct</span> <span class="o">=</span> <span class="n">MamsiStructSearch</span><span class="p">(</span><span class="n">rt_win</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">ppm</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># Load Selected LC-MS Features</span>
<span class="n">struct</span><span class="o">.</span><span class="n">load_lcms</span><span class="p">(</span><span class="n">selected</span><span class="p">)</span>

<span class="n">struct</span><span class="o">.</span><span class="n">get_structural_clusters</span><span class="p">(</span><span class="n">annotate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s2">&quot;display.max_rows&quot;</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>
</code></pre></div>
We can then perform the structural search. 
Note, use the <code>annotate=True</code> to get the annotation for selected features 
only if your LC-MS data originate from the National Phenome Centre or follow the NPC protocol.</p>
<p>We also need to perform hierarchical correlation clustering between selected features. 
You can choose either the silhouette method or define a straight cut-off on the dendrogram
<div class="highlight"><pre><span></span><code><span class="n">struct</span><span class="o">.</span><span class="n">get_correlation_clusters</span><span class="p">(</span><span class="n">flat_method</span><span class="o">=</span><span class="s1">&#39;silhouette&#39;</span><span class="p">,</span> <span class="n">max_clusters</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>
</code></pre></div>
Best number of clusters based on silhouette score: 8 </br>
Silhouette score for 8 clusters: 0.2436798413177305</p>
<p><img alt="Heatmap" src="../images/correlation_heatmap.png" />
<img alt="Silhouette Plot" src="../images/silhouette_plot.png" /></p>
<p>Finally we can visualise the structural relationships using a network plot. 
The different node colours represent different flattened hierarchical correlation clusters, while the edges between nodes identify their structural links. You can also save the network as an NX object and review in <a href="https://cytoscape.org">Cytoscape</a> to get better insight on what the structural relationship between individual features are (e.g. adduct links, isotopologues, cross-assay links).
<div class="highlight"><pre><span></span><code><span class="n">network</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">get_structural_network</span><span class="p">(</span><span class="n">include_all</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">interactive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_nx_object</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>
<img alt="Network" src="../images/network.png" /></p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.f8cc74c7.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.c8b220af.min.js"></script>
      
    
  </body>
</html>